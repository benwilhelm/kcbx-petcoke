#!/usr/bin/env node
var cwd = process.cwd();
require(cwd + "/lib/env");
var async = require('async');
var constants = require(cwd + "/lib/constants"),
    _ = require('lodash');

var weather = require(cwd + "/services/weather")
  , notifications = require(cwd + "/services/notifications")
  , smsSubscribers = require(cwd + "/services/smsSubscriber")
  , qryLat = constants.station_location.lat
  , qryLng = constants.station_location.lng
  ;

weather.getForecast(qryLat, qryLng, function(fcErr, fc) {
  
  if (fcErr) 
    return console.error(fcErr);

  var hazardous = _.find(constants.WIND_STATUS_TERMS, "term", "Hazardous");

  if (process.env.TEST_POLL_SCRIPT === 'true' // envvars are cast to strings
  ||  (fc && fc.currently.wind_speed >= hazardous.threshold)) {
    
    smsSubscribers.getSubscribers(function(smsErr, subscribers) {

      if (smsErr)
        return console.error(smsErr);

      var asyncFuncs = [];
      _.forEach(subscribers, function(subscriber){
        asyncFuncs.push(function(cb) {
          notifications.sendWindAlert(fc.currently.wind_speed, subscriber.phone, cb);
        })
      })

      async.parallel(asyncFuncs, function(err, rslt){
        if (err) console.error(err);
      })
    });
  }

});
